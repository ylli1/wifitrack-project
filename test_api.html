<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../static/test_api.css">
    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.0/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.0/mapbox-gl.css' rel='stylesheet' />
    
    <!-- direction api -->
	<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js'></script>
	<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css' type='text/css' />
    
    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>

    <!-- JQuery  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


    <!--chart api -->
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

	<script src="https://static.anychart.com/js/8.0.1/anychart-core.min.js"></script>
    <script src="https://static.anychart.com/js/8.0.1/anychart-pie.min.js"></script>
    

    <meta charset="UTF-8">
    <title>Wifi Analysis - Path Finding</title>
</head>
<body>
    <div class="heading">
        <h1>Wifi Analysis - Path Finding at Unimelb</h1>
    </div>

        
    </div>
    <div class="dateChoose">
            <select id = "mapChoose">
                <option value="people">People</option>
                <option value="device">Device</option>
            </select>
        Start Date
        <input id = "date" type="datetime-local" class="startDate" name="trip-start"
            value="2018-06-30T19:00" min="2018-05-01T00:00" max="2018-06-30T23:00">
        <button class="submit" type="submit" onclick="sendDate()">Submit</button>
    </div>

    <div class="tab">
        <button class="tablinks" onclick="openMap(event, 'People')" style="border-right: 1px solid #ccc;">People</button>
        <button class="tablinks" onclick="openMap(event, 'Devices')" style="border-right: 1px solid #ccc;">Devices</button>
        <!-- <button class="tablinks" onclick="openMap(event, 'Path')" style="border-right: 1px solid #ccc;">Path</button> -->
    </div>

    
    <div id="map"></div>
    <!-- <div id="Devices" class="tabcontent">
        <div class="dateChoose">Start Date
            <input type="datetime-local" class="startDate" name="trip-start"
                value="2018-05-30T19:00" min="2018-05-01T00:00" max="2018-06-30T23:00">
            <button class="submit fr">Submit</button>
        </div>
        <div id="deviceMap"></div>
    </div>

    <div id="Path" class="tabcontent">
        <div id="pathMap"></div>
    </div> -->
    <!-- <div id="demo"></div> -->
    <script >
        mapboxgl.accessToken = 'pk.eyJ1IjoiY2hhbmdkYWoiLCJhIjoiY2p6dWZ4ZnFpMDE1cjNtcGY4bTJ1Zm8ybyJ9.q9E3nHqoKER3Le3GWobzDA';
        // add base map 
        var map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/streets-v11',
            //style: 'mapbox://styles/mapbox/light-v8',
            center: [144.961027, -37.795947],
            zoom: 14.5,
        });


        // // add a route planner
        // map.addControl(new MapboxDirections({
        //     accessToken: mapboxgl.accessToken
        //     }), 
        //     'top-left'
        // );

        map.addControl(new mapboxgl.NavigationControl());


        var sampleJson = {
            // key1 & value1
            "keyName1": {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [144.961027, -37.795947]
            },
            "properties": {
                "building_name": "Art West",
                "detail":{
                    "PC": 100,
                    "Mobile": 200,
                    "Laptop": 700,
                },
                "total": 1000
            }
        },
            //key2 & value2
            "keyName2":{
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [144.960205, -37.797596]
            },
            "properties": {
                "building_name": "The Spot",
                "detail":{
                    "PC": 100,
                    "Mobile": 200,
                    "Laptop": 300,
                },
                "total": 600
            }
        }
        }   


        function transferJson(sampleJson){
            var geoJson = [];
            for(var keyname in sampleJson){
                geoJson.push(sampleJson[keyname]);
            }
            return geoJson;
        }

        var peopleGeoJSON = transferJson(sampleJson);
        console.log(peopleGeoJSON);
        
        map.on('load', function(){


            map.addLayer({
                'id': 'test',
                'type': 'circle',
                'source' : {
                    "type": "geojson",
                    "data": {
                        "type": "FeatureCollection",
                        "features": peopleGeoJSON,
                    }
                   
                },
                'paint':{
                    'circle-color': '#00b7bf',
                    'circle-radius': [
                        '/',['get','total'],50
                    ],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#333',
                }
            });

            map.on('click', 'test', function (e) {
					new mapboxgl.Popup()
					.setLngLat(e.lngLat)
					.setHTML(
                     "Building Name: " + e.features[0].properties.building_name
                    + "<br> detail: " + e.features[0].properties.detail
                    + "<br> total: " + e.features[0].properties.total
                    )

					.addTo(map);
                    });

            })


        function sendDate() {
            {#var js={a: 1}#}
            //send date JSON
            var mapType = document.getElementById("mapChoose").value;
            var date = document.getElementById("date").value;
            var submitJSON = {
                "mapType" : mapType,
                "date" : date
            }
            console.log(submitJSON);
            var data = JSON.stringify(submitJSON);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/users/');
            xhr.setRequestHeader('Content-Type', 'application/json'); // （前端）声明json格式
            xhr.send(data);// （前端）发送json数据
            xhr.addEventListener('loadend', function() {
                if(xhr.status == 201){ // 201，去看app.py！！
                var user = JSON.parse(xhr.responseText);                           // （前端）处理接收的json数据
                console.log(user);
                }
            }, false)};



        

    </script>
</body>
</html>
