<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="stylesheet" href="../static/test_api.css">

    <script src='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.js'></script>
    <link href='https://api.tiles.mapbox.com/mapbox-gl-js/v1.4.1/mapbox-gl.css' rel='stylesheet' />

    <!-- compare switch map -->
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.1.0/mapbox-gl-compare.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-compare/v0.1.0/mapbox-gl-compare.css' type='text/css' />

    <!-- direction api -->
	<script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.js'></script>
	<link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.0.2/mapbox-gl-directions.css' type='text/css' />

    <!-- Promise polyfill script required to use Mapbox GL Geocoder in IE 11 -->
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/es6-promise@4/dist/es6-promise.auto.min.js"></script>

    <!-- JQuery  -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>


    <!--chart api -->
	<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

	<script src="https://static.anychart.com/js/8.0.1/anychart-core.min.js"></script>
    <script src="https://static.anychart.com/js/8.0.1/anychart-pie.min.js"></script>


    <meta charset="UTF-8">
    <title>Wifi Analysis - Path Finding</title>
</head>
<body>

<style>
    body {
        overflow: hidden;
    }

    body * {
        -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
                -ms-user-select: none;
                    user-select: none;
    }

    .map {
        right: 70px;
        margin: auto;
        margin-top: 110px;
        position: absolute;
        top: 0;
        bottom: 10px;
        height: 550px;
        width: 1300px;
    }

    .dateChoose{
        margin: 10px auto 10px;
        width: 800px;
    }
</style>
    <div class="heading">
        <h1>Wifi Analysis - Path Finding at Unimelb</h1>
    </div>

    <div class="dateChoose">
        <select id = "mapChoose">
            <option value="people">People</option>
            <option value="device">Device</option>
        </select>

        Start Date
        <input id = "date" type="datetime-local" class="startDate" name="trip-start"
            value="2018-06-12T19:00" min="2018-05-01T00:00" max="2018-06-30T23:00">
        <button class="submit" type="submit" onclick="sendDate()">Submit</button>
        <br>
         <select id = "building">
                 <option value="Melbourne Law School">Law</option>
                 <option value="Doug McDonell">Doug McDonell</option>
                 <option value="Old Arts">Old Arts</option>
                 <option value="The Spot">The Spot</option>
                 <option value="Baillieu Library">Baillieu Library</option>
                 <option value="Alice Hoy">Alice Hoy</option>
                 <option value="Union House">Union House</option>
                 <option value="Arts West - West Wing">Arts West - West Wing</option>
                 <option value="Arts West - North Wing">Arts West - North Wing</option>
                 <option value="Eastern Resource Centre">Eastern Resource Centre</option>



         </select>

        Start Time
        <input id = "pathStartTime" type="datetime-local" class="startDate" name="trip-start"
            value="2018-06-12T10:00" min="2018-05-01T00:00" max="2018-06-30T23:00">
        End Time
        <input id = "pathEndTime" type="datetime-local" class="startDate" name="trip-start"
            value="2018-06-12T11:00" min="2018-05-01T00:00" max="2018-06-30T23:00">

        <button class="submit" type="submit" onclick="sendBuilding()">Submit</button>

    </div>


    <div id = "classify" class= "map">

    </div>

    <div id = "path" class = "map">

    </div>

    <script >

        mapboxgl.accessToken = 'pk.eyJ1IjoiY2hhbmdkYWoiLCJhIjoiY2p6dWZ4ZnFpMDE1cjNtcGY4bTJ1Zm8ybyJ9.q9E3nHqoKER3Le3GWobzDA';
        // add classify map
        var classifyMap = new mapboxgl.Map({
            container: 'classify',
            style: 'mapbox://styles/mapbox/streets-v11',
            //style: 'mapbox://styles/mapbox/light-v8',
            center: [144.961027, -37.795947],
            zoom: 14.5,
        });

        //add pathmap
         var pathMap = new mapboxgl.Map({
            container: 'path',
            //style: 'mapbox://styles/mapbox/streets-v11',
            style: 'mapbox://styles/mapbox/light-v8',
            center: [144.961027, -37.795947],
            zoom: 14.5,
        });

        //add swipe funtion
        var map= new mapboxgl.Compare(classifyMap, pathMap, {
            // Set this to enable comparing two maps by mouse movement:
            // mousemove: true
        });

        // initialize the map canvas to interact with later
        var canvas = pathMap.getCanvasContainer();

        //create global empty variables
        var user;
        var user2;


        // // add a route planner
         //map.addControl(new MapboxDirections({
           //  accessToken: mapboxgl.accessToken
             //}),
             //'top-left'
         //);

        //classifyMap.addControl(new mapboxgl.NavigationControl());


        //initial JSON for classify map
        var sampleJson = {
            // key1 & value1
            "keyName1": {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [144.961027, -37.795947]
            },
            "properties": {
                "building_name": "Art West",
                "detail":{
                    "PC": 100,
                    "Mobile": 200,
                    "Laptop": 700,
                },
                "total": 100
            }
        },
            //key2 & value2
            "keyName2":{
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [144.960205, -37.797596]
            },
            "properties": {
                "building_name": "The Spot",
                "detail":{
                    "PC": 100,
                    "Mobile": 200,
                    "Laptop": 300,
                },
                "total": 60
            }
        }
        }


        //transfer JSON to GeoJSON feature collection
        function transferJson(sampleJson){
            var geoJson = [];
            for(var keyname in sampleJson){
                geoJson.push(sampleJson[keyname]);
            }
            return geoJson;
        }


        var user = transferJson(sampleJson);
        console.log(user);

        //load classify map
        classifyMap.on('load', function(){

            classifyMap.addSource('wifiData',{
                'type': "geojson",
                'data': {
                        "type": "FeatureCollection",
                        "features": user,
                    }
            });

            classifyMap.addLayer({
                'id': 'test',
                'type': 'circle',
                'source' : 'wifiData',
                'paint':{
                    'circle-color': '#00b7bf',
                    'circle-radius': [
                        '/',['get','total'],10
                    ],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#333',
                    'circle-opacity': 0.3,
                }
            });

            var popup = new mapboxgl.Popup({
				closeButton: false,
				closeOnClick: false
			});

            classifyMap.on('mouseenter', 'test', function (e) {
					//new mapboxgl.Popup()
					popup.setLngLat(e.lngLat)
					popup.setHTML(
                     "Building Name: " + e.features[0].properties.building_name
                    + "<br> detail: " + e.features[0].properties.detail
                    + "<br> total: " + e.features[0].properties.total
                    )

					.addTo(classifyMap);
                    });

            classifyMap.on('mouseleave', 'test', function () {
					classifyMap.getCanvas().style.cursor = '';
					popup.remove();
					});

            classifyMap.on('click','test',function () {
                var geoJSON = transferJson(user)
                 classifyMap.getSource('wifiData').setData({
                        "type": "FeatureCollection",
                        "features":geoJSON,
                    });

            })

            });


        //path map part
        var sampleJson2 = {
            // key1 & value1
            "keyName1": {
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [144.961027, -37.795947]
            },
            "properties": {
                "building_type": "start",
                "building_name": "Art West",
                "total": 1000, //people in this building at start time
            }
        },
            //key2 & value2
            "keyName2":{
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [144.960205, -37.797596]
            },
            "properties": {
                "building_type": "destination",
                "building_name": "The Spot",
                "change": 30, //people from start building
            }
        },
            //key2 & value2
            "keyName3":{
            "type": "Feature",
            "geometry": {
                "type": "Point",
                "coordinates": [144.960205, -37.791596]
            },
            "properties": {
                "building_type": "destination",
                "building_name": "DMD",
                //"total": 700,
                "change": 70,
            }
        }
        };

        var user2 = transferJson(sampleJson2);
        //console.log(user2);

        var start = user2[0].geometry.coordinates;
        function getRoute(end) {
          // make a directions request using cycling profile
          // an arbitrary start will always be the same
          // only the end or destination will change
          var start = user2[0].geometry.coordinates;
          var url = 'https://api.mapbox.com/directions/v5/mapbox/walking/' + start[0] + ',' + start[1] + ';' + end[0] + ',' + end[1] + '?steps=true&geometries=geojson&access_token=' + mapboxgl.accessToken;

          // make an XHR request https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest
          var req = new XMLHttpRequest();
          req.responseType = 'json';
          req.open('GET', url, true);
          req.onload = function() {
            var data = req.response.routes[0];
            var route = data.geometry.coordinates;
            var geojson = {
              type: 'Feature',
              properties: {},
              geometry: {
                type: 'LineString',
                coordinates: route
              }
            };
            // if the route already exists on the map, reset it using setData
            if (pathMap.getSource('route')) {
              pathMap.getSource('route').setData(geojson);
            } else { // otherwise, make a new request
              pathMap.addLayer({
                id: 'route',
                type: 'line',
                source: {
                  type: 'geojson',
                  data: {
                    type: 'Feature',
                    properties: {},
                    geometry: {
                      type: 'LineString',
                      coordinates: geojson
                    }
                  }
                },
                layout: {
                  'line-join': 'round',
                  'line-cap': 'round'
                },
                paint: {
                  'line-color': '#3887be',
                  'line-width': 5,
                  'line-opacity': 0.75
                }
              });
            }
            // add turn instructions here at the end
          };
          req.send();
        }

        //load classify map
        pathMap.on('load', function(){

            getRoute(start);
            pathMap.addSource('pathData',{
                'type': "geojson",
                'data': {
                        "type": "FeatureCollection",
                        "features": user2,
                    }
            });

            pathMap.addLayer(
                //add building point to map
                {
                'id': 'test',
                'type': 'circle',
                'source' : 'pathData',
                'paint':{
                    'circle-color':[
                        'match',
                        ['get','building_type'],
                        'start','#fbb03b',
                        'destination','#223b53',
                        /*other*/'#ccc'
                    ],
                    'circle-radius': 8,
                    //'circle-radius': [
                    //    '/',['get','change'],1
                    //],
                    'circle-stroke-width': 1,
                    'circle-stroke-color': '#333',
                    'circle-opacity': 0.3,
                }
            },

            );

            pathMap.addLayer( // Add starting point to the map
                {
            id: 'point',
            type: 'circle',
            source: {
              type: 'geojson',
              data: {
                type: 'FeatureCollection',
                features: [{
                  type: 'Feature',
                  properties: {},
                  geometry: {
                    type: 'Point',
                    coordinates: start
                  }
                }
                ]
              }
            },
            paint: {
              'circle-radius': 1,
              'circle-color': '#3887be',
            }
          });

            var popup = new mapboxgl.Popup({
				closeButton: false,
				closeOnClick: false
			});

            pathMap.on('mouseenter', 'test', function (e) {
					//new mapboxgl.Popup()
					popup.setLngLat(e.lngLat)
					popup.setHTML(
                     "Building Name: " + e.features[0].properties.building_name
                    //+ "<br> detail: " + e.features[0].properties.detail
                    + "<br> total: " + e.features[0].properties.total
                    + "<br> change: " + e.features[0].properties.change

                    )

					.addTo(pathMap);
                    });

            pathMap.on('mouseleave', 'test', function () {
					pathMap.getCanvas().style.cursor = '';
					popup.remove();
					});

            pathMap.on('click','test',function () {
                var geoJSON2 = transferJson(user2);
                 pathMap.getSource('pathData').setData({
                        "type": "FeatureCollection",
                        "features":user2,
                    });

            })

            // make an initial directions request that
          // starts and ends at the same location


                // this is where the code from the next step will go
                pathMap.on('click', function (e) {
                    var coordsObj = e.lngLat;
                    canvas.style.cursor = '';
                    var coords = Object.keys(coordsObj).map(function (key) {
                        return coordsObj[key];
                    });
                    var end = {
                        type: 'FeatureCollection',
                        features: [{
                            type: 'Feature',
                            properties: {},
                            geometry: {
                                type: 'Point',
                                coordinates: coords
                            }
                        }
                        ]
                    };
                    if (pathMap.getLayer('end')) {
                        pathMap.getSource('end').setData(end);
                    } else {
                        pathMap.addLayer({
                            id: 'end',
                            type: 'circle',
                            source: {
                                type: 'geojson',
                                data: {
                                    type: 'FeatureCollection',
                                    features: [{
                                        type: 'Feature',
                                        properties: {},
                                        geometry: {
                                            type: 'Point',
                                            coordinates: coords
                                        }
                                    }]
                                }
                            },
                            paint: {
                                'circle-radius': 1,
                                'circle-color': '#f30',
                            }
                        });
                    }
                    getRoute(coords);
                });
            });




        function sendDate() {
            {#var js={a: 1}#}
            //send date JSON
            var mapType = document.getElementById("mapChoose").value;
            var date = document.getElementById("date").value;
            var submitJSON = {
                "mapType" : mapType,
                "date" : date
            }
            console.log(submitJSON);
            var data = JSON.stringify(submitJSON);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/users/');
            xhr.setRequestHeader('Content-Type', 'application/json'); // （前端）声明json格式
            xhr.send(data);// （前端）发送json数据
            xhr.addEventListener('loadend', function() {
                if(xhr.status == 201){ // 201，去看app.py！！
                var userJSON = JSON.parse(xhr.responseText);                           // （前端）处理接收的json数据
                user = transferJson(userJSON);
                console.log(user);
                }
            }, false)};

        function sendBuilding() {
            {#var js={a: 1}#}
            //send date JSON
            var building = document.getElementById("building").value;
            var pathStartTime = document.getElementById("pathStartTime").value;
            var pathEndTime = document.getElementById("pathEndTime").value;
            var submitJSON2 = {
                "mapType" : "path",
                "building" : building,
                "pathStartTime" : pathStartTime,
                "pathEndTime" : pathEndTime,
            }
            console.log(submitJSON2);
            var data2 = JSON.stringify(submitJSON2);

            var xhr = new XMLHttpRequest();
            xhr.open('POST', '/users/');
            xhr.setRequestHeader('Content-Type', 'application/json'); // （前端）声明json格式
            xhr.send(data2);// （前端）发送json数据
            xhr.addEventListener('loadend', function() {
                if(xhr.status == 201){ // 201，去看app.py！！
                var userJSON2 = JSON.parse(xhr.responseText);                           // （前端）处理接收的json数据
                user2 = transferJson(userJSON2);
                console.log(user2);
                }
            }, false)

        };





    </script>
</body>
</html>
